name: Deploy The Word Today Cron (Secondary Firebase)

on:
  push:
    branches:
      - main
    paths:
      - 'the_word_today_cron/**'
  workflow_dispatch:  # Allow manual triggers

env:
  FUNCTION_NAME: the-word-today-cron-secondary
  REGION: us-central1
  RUNTIME: python311
  ENTRY_POINT: the_word_today_cron

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd the_word_today_cron
          pip install -r requirements.txt

      - name: ðŸ” Authenticate to Google Cloud (Secondary Project) - Workload Identity
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER_SECONDARY }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_SECONDARY }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID_SECONDARY }}

      - name: ðŸ“¤ Deploy Cloud Function to Secondary Project
        env:
          DRY_RUN: ${{ secrets.DRY_RUN || 'False' }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "ðŸŽ¯ Deploying The Word Today Cron to secondary Firebase project: ${{ secrets.GCP_PROJECT_ID_SECONDARY }}"
          echo "â„¹ï¸  This function will use Application Default Credentials"
          echo "â„¹ï¸  No Firebase service account keys needed - uses Workload Identity Federation"
          echo "â„¹ï¸  Function runs in same GCP project as Firebase, so ADC works automatically"
          
          # Use default compute service account to avoid org policy IAM issues
          # Deploy WITHOUT --allow-unauthenticated to avoid IAM policy changes during deployment
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID_SECONDARY }} --format="value(projectNumber)")
          DEFAULT_SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
          
          echo "Using default compute service account: $DEFAULT_SA"
          echo "Deploying WITHOUT --allow-unauthenticated to avoid org policy IAM issues"
          echo "Will grant invoke permissions separately after deployment"
          
          # Deploy without --allow-unauthenticated to avoid IAM policy changes
          echo "Deploying function (this may take a few minutes)..."
          gcloud functions deploy ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --runtime=${{ env.RUNTIME }} \
            --region=${{ env.REGION }} \
            --source=the_word_today_cron \
            --entry-point=${{ env.ENTRY_POINT }} \
            --trigger-http \
            --no-allow-unauthenticated \
            --memory=512MB \
            --timeout=540s \
            --max-instances=10 \
            --service-account="$DEFAULT_SA" \
            --set-env-vars="DRY_RUN=${DRY_RUN},YOUTUBE_API_KEY=${YOUTUBE_API_KEY},FIREBASE_PROJECT_ID_SECONDARY=${{ secrets.GCP_PROJECT_ID_SECONDARY }}" \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
          
          # Grant invoke permission to allUsers AFTER deployment (using Cloud Run IAM)
          # NOTE: This may fail due to org policy - if so, grant manually via console
          echo ""
          echo "Attempting to grant invoke permission to allUsers via Cloud Run IAM..."
          echo "If this fails due to org policy, grant manually via console (see note below)"
          SERVICE_NAME="${{ env.FUNCTION_NAME }}"
          if gcloud run services add-iam-policy-binding "$SERVICE_NAME" \
            --region=${{ env.REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            2>&1; then
            echo "âœ… Successfully granted allUsers permission"
          else
            echo "âš ï¸ Could not grant allUsers permission automatically (org policy restriction)"
            echo "âš ï¸ Please grant manually via console:"
            echo "   https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.FUNCTION_NAME }}?project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}"
            echo "   Click 'PERMISSIONS' tab â†’ 'ADD PRINCIPAL' â†’ allUsers â†’ roles/run.invoker"
            echo "   Deployment will continue, but function won't be publicly accessible until permission is granted"
          fi

      - name: ðŸ”— Get Function URL
        id: get-url
        run: |
          FUNCTION_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            --format="value(serviceConfig.uri)")
          echo "url=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "âœ… Function URL: $FUNCTION_URL"

      - name: ðŸ” Grant App Engine Service Account Invoke Permission
        run: |
          # Use App Engine default service account for OIDC (doesn't require actAs permission)
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID_SECONDARY }} --format="value(projectNumber)")
          APP_ENGINE_SA="${PROJECT_NUMBER}@appspot.gserviceaccount.com"
          
          echo "Granting invoke permission to App Engine service account: $APP_ENGINE_SA"
          SERVICE_NAME="${{ env.FUNCTION_NAME }}"
          if gcloud run services add-iam-policy-binding "$SERVICE_NAME" \
            --region=${{ env.REGION }} \
            --member="serviceAccount:${APP_ENGINE_SA}" \
            --role="roles/run.invoker" \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            2>&1; then
            echo "âœ… Granted invoke permission to App Engine service account"
          else
            echo "âš ï¸ Could not grant permission automatically (may need manual grant)"
          fi
          
          # Store App Engine SA for use in subsequent steps
          echo "SCHEDULER_SA=${APP_ENGINE_SA}" >> $GITHUB_ENV

      - name: â° Create/Update 4 AM ET (09:00 UTC) Scheduler Job
        run: |
          JOB_NAME="${FUNCTION_NAME}-4am-et"
          FUNCTION_URL="${{ steps.get-url.outputs.url }}"
          
          echo "Creating/updating scheduler job: $JOB_NAME"
          
          if gcloud scheduler jobs describe "$JOB_NAME" \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            >/dev/null 2>&1; then
            echo "Job exists, updating..."
            gcloud scheduler jobs update http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 9 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job updated successfully"
          else
            echo "Job does not exist, creating..."
            gcloud scheduler jobs create http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 9 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --description="Daily run at 4 AM ET (09:00 UTC) for The Word Today service (SECONDARY)" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job created successfully"
          fi

      - name: â° Create/Update 6 AM ET (11:00 UTC) Scheduler Job
        run: |
          JOB_NAME="${FUNCTION_NAME}-6am-et"
          FUNCTION_URL="${{ steps.get-url.outputs.url }}"
          
          echo "Creating/updating scheduler job: $JOB_NAME"
          
          if gcloud scheduler jobs describe "$JOB_NAME" \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            >/dev/null 2>&1; then
            echo "Job exists, updating..."
            gcloud scheduler jobs update http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 11 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job updated successfully"
          else
            echo "Job does not exist, creating..."
            gcloud scheduler jobs create http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 11 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --description="Daily run at 6 AM ET (11:00 UTC) for The Word Today service (SECONDARY)" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job created successfully"
          fi

      - name: â° Create/Update 9 AM ET (14:00 UTC) Scheduler Job
        run: |
          JOB_NAME="${FUNCTION_NAME}-9am-et"
          FUNCTION_URL="${{ steps.get-url.outputs.url }}"
          
          echo "Creating/updating scheduler job: $JOB_NAME"
          
          if gcloud scheduler jobs describe "$JOB_NAME" \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            >/dev/null 2>&1; then
            echo "Job exists, updating..."
            gcloud scheduler jobs update http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 14 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job updated successfully"
          else
            echo "Job does not exist, creating..."
            gcloud scheduler jobs create http "$JOB_NAME" \
              --location=${{ env.REGION }} \
              --schedule="0 14 * * *" \
              --uri="$FUNCTION_URL" \
              --http-method=GET \
              --time-zone="America/New_York" \
              --description="Daily run at 9 AM ET (14:00 UTC) for The Word Today service (SECONDARY)" \
              --attempt-deadline=600s \
              --oidc-service-account-email="${SCHEDULER_SA}" \
              --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }}
            echo "âœ… Scheduler job created successfully"
          fi

      - name: âœ… Verify Deployment
        run: |
          echo "ðŸŽ‰ Secondary The Word Today Cron deployment completed successfully!"
          echo "Project: ${{ secrets.GCP_PROJECT_ID_SECONDARY }}"
          echo "Function: ${{ env.FUNCTION_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo "URL: ${{ steps.get-url.outputs.url }}"
          echo ""
          echo "Scheduler jobs:"
          gcloud scheduler jobs list --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID_SECONDARY }} \
            --filter="name~${{ env.FUNCTION_NAME }}" \
            --format="table(name,schedule,state)"

